class SourceCode{constructor(e){this.engine=e,this.videos={},e.isEditor()&&e.addEventListener("start",e=>{document.getElementById("editor").classList.remove("hidden"),document.getElementById("editor").style.display="none",setTimeout(()=>{document.getElementById("editor").style.display=""},1e3),e.addEventListener("sceneChange",()=>{this.refreshView()});["scene-code","config","assets","design-tab","code-tab"].forEach(e=>{document.getElementById(e).addEventListener("mousedown",()=>{this.selectTab(e)})}),SceneThumbnail.instance.addEventListener("shift",e=>{e?(this.refreshView(),this.engine.keyboard.active=!1):(this.pause(),this.engine.keyboard.active=!0)})})}selectTab(e){{const t=document.querySelectorAll("#editor-tabs > .tab");if(document.querySelector(`#editor-tabs > .tab#${e}`))for(let n=0;n<t.length;n++){const s=t[n];s.id===e?s.classList.add("selected"):s.classList.remove("selected")}}{const t=document.querySelectorAll("#code-tabs > .tab");if(document.querySelector(`#code-tabs > .tab#${e}`))for(let n=0;n<t.length;n++){const s=t[n];s.id===e?s.classList.add("selected"):s.classList.remove("selected")}}this.refreshView()}selectedEditorTab(){const e=document.querySelectorAll("#editor-tabs > .tab");for(let t=0;t<e.length;t++){const n=e[t];if(n.classList.contains("selected"))return n.id}return null}selectedCoderTab(){const e=document.querySelectorAll("#code-tabs > .tab");for(let t=0;t<e.length;t++){const n=e[t];if(n.classList.contains("selected"))return n.id}return null}pause(){for(let e in this.videos)this.videos[e].pause()}refreshView(){if(this.pause(),document.getElementById("source-code").style.display="none",document.getElementById("assets-container").style.display="none","code-tab"===this.selectedCoderTab())switch(this.selectedEditorTab()){case"scene-code":SourceCode.instance.render(this.engine.makeScene(this.engine.currentSceneName));break;case"config":SourceCode.instance.render(getData().generated.game);break;case"assets":const{data:{generated:{imagedata:e,videos:t}},spriteDataProcessor:n}=this.engine,s=this.engine.currentSceneName,i=[],d=[],o=this.engine.currentScene.spriteData.map(e=>e.src.get());for(let t in e.sprites){const{scenes:n,font:d}=e.sprites[t];(n.indexOf(s)>=0||o.indexOf(t)>=0)&&i.push(t)}for(let e in t)t[e].scenes.indexOf(s)>=0&&d.push(e);this.renderAssets(i,d)}else this.selectedCoderTab().id;document.querySelector("#scene-code").innerText=`scenes/${this.engine.currentSceneName}/start.js`,document.querySelector("#assets").innerText=`scenes/${this.engine.currentSceneName}/assets`}static formatCode(e,t){const n=SourceCode.instance.formatCode(e);return t?Tools.beautify(n,{wrap_line_length:100}):n}static codeToBlob(e){const t=SourceCode.instance.formatCode(e);return URL.createObjectURL(new Blob([t],{type:"application/javascript"}))}formatCode(e){switch(typeof e){case"function":return e.toString();case"string":return JSON.stringify(e);case"object":if(e.toSourceCode)return e.toSourceCode(null,this);break;case"number":return e%1==0&&e>=10?`${JSON.stringify(e)} /*0x${e.toString(16)}*/`:JSON.stringify(e);default:return`${e}`}const t=Array.isArray(e);if(t){return`[ ${e.map((e,t)=>`${this.formatCode(e)}\n`).join(",")} ]`}{let t="";for(let n in e)e.hasOwnProperty(n)&&(t+=`${Tools.isVarName(n)?n:`"${n}"`}: ${this.formatCode(e[n])},\n`);return`{ ${t} }`}}render(e){const t=document.getElementById("source-code");t.innerHTML=Tools.highlight("javascript",SourceCode.formatCode(e,!0),!0).value,t.style.display=""}renderAssets(e,t){const{sprites:n}=this.engine.data.generated.imagedata,s=document.querySelector("#assets-container");s.style.display="",s.innerHTML="",s.style.display="flex",s.style.flexWrap="wrap",e.forEach(e=>{const t=s.appendChild(document.createElement("div"));t.style.margin="5px";const n=t.appendChild(document.createElement("div"));n.style.width="80px",n.style.height="80px",n.style.border="1px solid #aaaaaa",n.style.padding="4px";const i=n.appendChild(document.createElement("canvas"));i.style.width="100%",i.style.height="100%",i.width=160,i.height=160,this.engine.canvasRenderer.drawToCanvas(e,0,0,160,160,i);const d=t.appendChild(document.createElement("div"));d.style.fontSize="8pt",d.style.fontFamily="Courier New",d.style.marginBottom="10px",d.style.textAlign="center",d.style.backgroundColor="#333333",d.innerText=e}),t.forEach(e=>{if(!this.engine.data.generated.videos[e])return;const{id:t,path:n}=this.engine.data.generated.videos[e],i=s.appendChild(document.createElement("div"));i.style.margin="5px";const d=i.appendChild(document.createElement("div"));d.style.border="1px solid #aaaaaa",d.style.width="80px",d.style.height="80px",d.style.padding="4px",d.style.display="flex",d.style.justifyContent="center",d.style.alignItems="center";if(this.videos[e])d.appendChild(this.videos[e]),this.videos[e].play();else{const s=d.appendChild(document.createElement("video"));s.addEventListener("canplay",e=>{const{videoWidth:t,videoHeight:n}=s,i=Math.min(160/t,160/n);s.style.width=`${i*t/2}px`,s.style.height=`${i*n/2}px`,s.volume=0,s.play()}),s.id=t,s.src=n,this.videos[e]=s}const o=i.appendChild(document.createElement("div"));o.style.fontSize="8pt",o.style.fontFamily="Courier New",o.style.marginBottom="10px",o.style.textAlign="center",o.style.backgroundColor="#333333",o.innerText=t})}}document.addEventListener("DOMContentLoaded",()=>SourceCode.instance=new SourceCode(engine));const EditorMode={Hidden:0,Shifted:1,Split:2,NumModes:3};class SceneThumbnail{constructor(e){this.onShiftListener=[],e.isEditor()&&(this.mode=EditorMode.Hidden,e.addEventListener("start",e=>{this.setupSceneThumbnails(e)}),e.addEventListener("sceneChange",e=>{const t=document.getElementById("scene-thumbnails").querySelectorAll(".scene-tab");for(let n=0;n<t.length;n++){const s=t[n];s.id===`tab-${e}`?s.classList.add("selected"):s.classList.remove("selected")}}))}setupSceneThumbnails({canvas:e}){const t=e.parentElement.insertBefore(document.createElement("div"),e);t.id="scene-thumbnails",t.classList.add("tab-container"),t.style.display="none",setTimeout(()=>{t.style.display=""},1e3);const n=t.appendChild(document.createElement("div"));n.classList.add("tab-container");for(let e in engine.sceneManager.scenes){const t=n.appendChild(document.createElement("div"));t.id=`tab-${e}`,t.classList.add("tab"),t.classList.add("scene-tab"),t.innerText=e,t.scene=e,t.addEventListener("click",e=>engine.gotoScene(e.currentTarget.scene))}t.appendChild(document.createElement("div")).style.width="100%";const s=t.appendChild(document.createElement("div"));s.classList.add("panel-button"),s.id="panel-button",s.innerText="⬅️EDITOR",s.addEventListener("click",()=>this.shiftPanel(EditorMode.Shifted)),this.shiftPanel(this.mode)}shiftPanel(e){switch(this.mode=void 0===e?(this.mode+1)%EditorMode.NumModes:e,this.mode){case EditorMode.Hidden:document.getElementById("panel").classList.remove("shifted"),document.getElementById("editor").classList.remove("shifted"),document.getElementById("panel").classList.remove("split"),document.getElementById("editor").classList.remove("split"),document.getElementById("panel-button").classList.remove("hidden"),document.getElementById("panel-exit-button").classList.add("hidden");break;case EditorMode.Shifted:document.getElementById("panel").classList.add("shifted"),document.getElementById("editor").classList.add("shifted"),document.getElementById("panel").classList.remove("split"),document.getElementById("editor").classList.remove("split"),document.getElementById("panel-button").classList.add("hidden"),document.getElementById("panel-exit-button").classList.remove("hidden"),document.getElementById("panel-exit-button").innerText="SPLIT ➡️";break;case EditorMode.Split:document.getElementById("panel").classList.remove("shifted"),document.getElementById("editor").classList.remove("shifted"),document.getElementById("panel").classList.add("split"),document.getElementById("editor").classList.add("split"),document.getElementById("panel-button").classList.add("hidden"),document.getElementById("panel-exit-button").classList.remove("hidden"),document.getElementById("panel-exit-button").innerText="GAME ➡️"}this.onShiftListener.forEach(t=>{t(e)})}addEventListener(e,t){switch(e){case"shift":this.onShiftListener.indexOf(t)<0&&this.onShiftListener.push(t)}}removeEventListener(e,t){switch(e){case"shift":const n=this.onShiftListener.indexOf(t);n>=0&&this.onShiftListener.splice(n,1)}}}document.addEventListener("DOMContentLoaded",()=>SceneThumbnail.instance=new SceneThumbnail(engine));