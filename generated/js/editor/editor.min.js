class EditorUtils{static formatCode(e,t){const s=EditorUtils.formatCodeHelper(e);return t?Tools.beautify(s,{wrap_line_length:100}):s}static codeToBlob(e){const t=EditorUtils.formatCodeHelper(e);return URL.createObjectURL(new Blob([t],{type:"application/javascript"}))}static formatCodeHelper(e){switch(typeof e){case"function":return e.toString();case"string":return JSON.stringify(e);case"object":if(e.toSourceCode)return e.toSourceCode();break;case"number":return e%1==0&&e>=10?`${JSON.stringify(e)} /*0x${e.toString(16)}*/`:JSON.stringify(e);default:return`${e}`}const t=Array.isArray(e);if(t){return`[ ${e.map((e,t)=>`${EditorUtils.formatCodeHelper(e)}\n`).join(",")} ]`}{let t="";for(let s in e)e.hasOwnProperty(s)&&(t+=`${Tools.isVarName(s)?s:`"${s}"`}: ${EditorUtils.formatCodeHelper(e[s])},\n`);return`{ ${t} }`}}}class SourceCode{constructor(e){this.engine=e,this.videos={},this.sceneName=null,e.isEditor()&&e.addEventListener("start",e=>{document.getElementById("editor").classList.remove("hidden"),document.getElementById("editor").style.display="none",setTimeout(()=>{document.getElementById("editor").style.display=""},1e3),e.addEventListener("sceneChange",e=>{this.sceneName=e,this.refreshView()});["scene-code","config","assets","design-tab","code-tab"].forEach(e=>{document.getElementById(e).addEventListener("mousedown",()=>{this.selectTab(e)})}),SceneThumbnail.instance.addEventListener("shift",e=>{e?(this.refreshView(),this.engine.keyboard.active=!1):(this.pause(),this.engine.keyboard.active=!0)})})}selectTab(e){{const t=document.querySelectorAll("#editor-tabs > .tab");if(document.querySelector(`#editor-tabs > .tab#${e}`))for(let s=0;s<t.length;s++){const n=t[s];n.id===e?n.classList.add("selected"):n.classList.remove("selected")}}{const t=document.querySelectorAll("#code-tabs > .tab");if(document.querySelector(`#code-tabs > .tab#${e}`))for(let s=0;s<t.length;s++){const n=t[s];n.id===e?n.classList.add("selected"):n.classList.remove("selected")}}this.refreshView()}selectedEditorTab(){const e=document.querySelectorAll("#editor-tabs > .tab");for(let t=0;t<e.length;t++){const s=e[t];if(s.classList.contains("selected"))return s.id}return null}selectedCoderTab(){const e=document.querySelectorAll("#code-tabs > .tab");for(let t=0;t<e.length;t++){const s=e[t];if(s.classList.contains("selected"))return s.id}return null}pause(){for(let e in this.videos)this.videos[e].pause()}refreshView(){if(this.pause(),document.getElementById("source-code").style.display="none",document.getElementById("assets-container").style.display="none","code-tab"===this.selectedCoderTab())switch(this.selectedEditorTab()){case"scene-code":SourceCode.instance.render(this.engine.makeScene(this.sceneName));break;case"config":SourceCode.instance.render(getData().generated.game);break;case"assets":const{data:{generated:{imagedata:e,videos:t}},spriteDataProcessor:s}=this.engine,n=[],i=[],d=this.engine.currentScene?this.engine.currentScene.spriteData.map(e=>e.src.get()):[];for(let t in e.sprites){const{scenes:s,font:i}=e.sprites[t];(s.indexOf(this.sceneName)>=0||d.indexOf(t)>=0)&&n.push(t)}for(let e in t)t[e].scenes.indexOf(this.sceneName)>=0&&i.push(e);this.renderAssets(n,i)}else this.selectedCoderTab().id;document.querySelector("#scene-code").innerText=`scenes/${this.sceneName}/start.js`,document.querySelector("#assets").innerText=`scenes/${this.sceneName}/assets`}render(e){const t=document.getElementById("source-code");this.engine.workerManager.beautifyCode(EditorUtils.formatCode(e,!0),e=>{t.innerHTML=e,t.style.display=""})}renderAssets(e,t){const{sprites:s}=this.engine.data.generated.imagedata,n=document.querySelector("#assets-container");n.style.display="",n.innerHTML="",n.style.display="flex",n.style.flexWrap="wrap",e.forEach(e=>{const t=n.appendChild(document.createElement("div"));t.style.margin="5px";const s=t.appendChild(document.createElement("div"));s.style.width="80px",s.style.height="80px",s.style.border="1px solid #aaaaaa",s.style.padding="4px";const i=s.appendChild(document.createElement("canvas"));i.style.width="100%",i.style.height="100%",i.width=160,i.height=160,this.engine.canvasRenderer.drawToCanvas(e,0,0,160,160,i);const d=t.appendChild(document.createElement("div"));d.style.fontSize="8pt",d.style.fontFamily="Courier New",d.style.marginBottom="10px",d.style.textAlign="center",d.style.backgroundColor="#333333",d.innerText=e}),t.forEach(e=>{if(!this.engine.data.generated.videos[e])return;const{id:t,path:s}=this.engine.data.generated.videos[e],i=n.appendChild(document.createElement("div"));i.style.margin="5px";const d=i.appendChild(document.createElement("div"));d.style.border="1px solid #aaaaaa",d.style.width="80px",d.style.height="80px",d.style.padding="4px",d.style.display="flex",d.style.justifyContent="center",d.style.alignItems="center";if(this.videos[e])d.appendChild(this.videos[e]),this.videos[e].play();else{const n=d.appendChild(document.createElement("video"));n.addEventListener("canplay",e=>{const{videoWidth:t,videoHeight:s}=n,i=Math.min(160/t,160/s);n.style.width=`${i*t/2}px`,n.style.height=`${i*s/2}px`,n.volume=0,n.play()}),n.id=t,n.src=s,this.videos[e]=n}const o=i.appendChild(document.createElement("div"));o.style.fontSize="8pt",o.style.fontFamily="Courier New",o.style.marginBottom="10px",o.style.textAlign="center",o.style.backgroundColor="#333333",o.innerText=t})}}document.addEventListener("DOMContentLoaded",()=>SourceCode.instance=new SourceCode(engine));const EditorMode={Hidden:0,Shifted:1,Split:2,NumModes:3};class SceneThumbnail{constructor(e){this.onShiftListener=[],e.isEditor()&&(this.mode=EditorMode.Hidden,e.addEventListener("start",e=>{this.setupSceneThumbnails(e)}),e.addEventListener("sceneChange",e=>{const t=document.getElementById("scene-thumbnails").querySelectorAll(".scene-tab");for(let s=0;s<t.length;s++){const n=t[s];n.id===`tab-${e}`?n.classList.add("selected"):n.classList.remove("selected")}}))}setupSceneThumbnails({canvas:e}){const t=e.parentElement.insertBefore(document.createElement("div"),e);t.id="scene-thumbnails",t.classList.add("tab-container"),t.style.display="none",setTimeout(()=>{t.style.display=""},1e3);const s=t.appendChild(document.createElement("div"));s.classList.add("tab-container");for(let e in engine.sceneManager.scenes){const t=s.appendChild(document.createElement("div"));t.id=`tab-${e}`,t.classList.add("tab"),t.classList.add("scene-tab"),t.innerText=e,t.scene=e,t.addEventListener("click",e=>engine.gotoScene(e.currentTarget.scene))}t.appendChild(document.createElement("div")).style.width="100%";const n=t.appendChild(document.createElement("div"));n.classList.add("panel-button"),n.id="panel-button",n.innerText="⬅️EDITOR",n.addEventListener("click",()=>this.shiftPanel(EditorMode.Shifted)),this.shiftPanel(this.mode)}shiftPanel(e){switch(this.mode=void 0===e?(this.mode+1)%EditorMode.NumModes:e,this.mode){case EditorMode.Hidden:document.getElementById("panel").classList.remove("shifted"),document.getElementById("editor").classList.remove("shifted"),document.getElementById("panel").classList.remove("split"),document.getElementById("editor").classList.remove("split"),document.getElementById("panel-button").classList.remove("hidden"),document.getElementById("panel-exit-button").classList.add("hidden");break;case EditorMode.Shifted:document.getElementById("panel").classList.add("shifted"),document.getElementById("editor").classList.add("shifted"),document.getElementById("panel").classList.remove("split"),document.getElementById("editor").classList.remove("split"),document.getElementById("panel-button").classList.add("hidden"),document.getElementById("panel-exit-button").classList.remove("hidden"),document.getElementById("panel-exit-button").innerText="SPLIT ➡️";break;case EditorMode.Split:document.getElementById("panel").classList.remove("shifted"),document.getElementById("editor").classList.remove("shifted"),document.getElementById("panel").classList.add("split"),document.getElementById("editor").classList.add("split"),document.getElementById("panel-button").classList.add("hidden"),document.getElementById("panel-exit-button").classList.remove("hidden"),document.getElementById("panel-exit-button").innerText="GAME ➡️"}this.onShiftListener.forEach(t=>{t(e)})}addEventListener(e,t){switch(e){case"shift":this.onShiftListener.indexOf(t)<0&&this.onShiftListener.push(t)}}removeEventListener(e,t){switch(e){case"shift":const s=this.onShiftListener.indexOf(t);s>=0&&this.onShiftListener.splice(s,1)}}}document.addEventListener("DOMContentLoaded",()=>SceneThumbnail.instance=new SceneThumbnail(engine));